---
- hosts: all
  sudo: yes
  tasks:
    - name: ensure  public key
      authorized_key: user=ezhuwya key="ssh-dss AAAAB3NzaC1kc3MAAACBAIaV29gxlGNBeIk0FSlTOmPwRRXsBms6Jd8HQr/iSM3DioB3FfYMDS/76Qfr4LUI2C2Xf5WH5WnbCAg7Kb+v/RhA5bSKr8efn5g71xqNUOBBROBvAF8OOlo5BhylKHLjl0lFfXTk7BoCHm6bqjRXDWn27S9MNQVgVfT6tDIu1E/xAAAAFQCNSj1a2rLBieKF+mirBu6MmM/UUwAAAIBf3NockgYGZh3wi1nvtl8ZCa4cp0YO75nc4BaXZmqSOeh6ElfWeNyICBNmZyK/g4/wJjEqBihs24KYDgc8eKxnvTjRydso1vbb8AFYOD7WLHOJgmc8gMrs9eJM5DcRSI45rqWp4lfK7qNC4WQap+CI4I5lPUjtB3jEhZmoFcdENAAAAIA6ddqv29S805RN4DXYUHbPy+oFfMqj8X3iRv1xqXMqjVkKGQ9w9Fj+3wdmBevw5B+kCc/mXLOWg9MMGuoSU+8jOwmwa7LPo5FLu6j781VUV1ehI+3lmE3RNvZUPu6g+41Vjah+KMl+KsGIWPW7AHzr+on2zKCmHZLQaq94dpfDBA==" state=present

    - name: sudo nopass
      lineinfile: create=false dest="/etc/sudoers" line="%sudo	ALL=(ALL:ALL) NOPASSWD:ALL"
       
    - name:  install tools
      apt: name={{ item }} update_cache=yes
      with_items:
        - apt-transport-https
        - ca-certificates

    - name: install docker pgp key
      apt_key: keyserver="hkp://p80.pool.sks-keyservers.net:80" id=58118E89F3A912897C070ADBF76221572C52609D

    - name: docker apt src file
      lineinfile: create=true dest="/etc/apt/sources.list.d/docker.list" line="deb https://apt.dockerproject.org/repo ubuntu-trusty main"

    - name: apt install docker 
      apt: name=docker-engine update_cache=yes

    - name: start docker service
      service: name=docker enabled=yes state=started

    - name: add ezhuwya to docker group
      user: name=ezhuwya groups=docker,sudo

    - name: jenkins key
      command: sh -c 'wget -q -O - https://jenkins-ci.org/debian/jenkins-ci.org.key |  apt-key add -'

    - name: jenkins apt src
      command: sh -c 'echo deb http://pkg.jenkins-ci.org/debian binary/ > /etc/apt/sources.list.d/jenkins.list'

    - name: install jenkins
      apt: name=jenkins update_cache=yes

    - name: jenkins run docker 
      user: name=jenkins groups=docker

    - name: ignore lid close
      lineinfile: create=false dest="/etc/systemd/logind.conf" line="HandleLidSwitch=ignore"
      
    - name: restart systemd-logind
      service: name=systemd-logind state=restarted

    - name: restart jenkins
      service: name=jenkins state=restarted

    - name: install python libs
      command: pip install bs4 elasticsearch

      
